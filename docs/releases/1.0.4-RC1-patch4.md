# Release v1.0.4-RC1-patch4

**Release Date:** August 26, 2025  
**Type:** Critical Fix + Observability Enhancement  
**Branch:** 1.0-RC1-patch4

## Critical Discord Observer Fix

### Fixed

1. **Discord Observer Not Creating Tasks for WA Users in Monitored Channels**
   - Issue: Messages from Wise Authority users in monitored channels (like #ai-social) were being ignored
   - Root Cause: Incorrect if-elif-else logic was checking WA status for ALL channels instead of just deferral channel
   - Impact: @mentions and messages from WA users weren't creating tasks, causing agents to not respond
   - Fix: Restructured routing logic to:
     - Create tasks for ANY message in monitored channels (regardless of WA status)
     - Only check WA status for deferral channel routing
     - Properly handle all message routing scenarios

2. **Enhanced Channel ID Extraction**
   - Issue: Channel ID extraction only handled one format
   - Fix: Now properly handles both formats:
     - `discord_channelid`
     - `discord_guildid_channelid`
   - Impact: More robust channel matching and routing

## Observability Enhancements

### Comprehensive Logging System

Added clear, actionable logging throughout the observer chain:

#### Base Observer Logging (`[OBSERVER]` prefix)
- **INFO**: Processing start, task creation with IDs and priorities
- **WARNING**: Messages filtered out by adaptive filter (with reasons and triggered filters)
- **INFO**: Agent's own messages detected

#### Discord Observer Logging (`[DISCORD-PRIORITY]` / `[DISCORD-PASSIVE]` prefix)
- **INFO**: Routing decisions with full context
- **INFO**: Task creation for monitored channels
- **WARNING**: When tasks aren't created (with detailed diagnostics)
- **INFO**: WA feedback routing for deferral channel

### Example Log Output

```
[OBSERVER] Processing message msg123 from @User (ID: 456) in channel 1396158748606726354
[OBSERVER] Message msg123 PASSED filter with priority critical: at_mention detected
[DISCORD-PRIORITY] Routing message msg123 from @User (ID: 456) in channel 1396158748606726354
[DISCORD-PRIORITY] Channel 1396158748606726354 IS MONITORED - CREATING PRIORITY TASK (priority: critical, filters: at_mention)
[OBSERVER] PRIORITY TASK CREATED: task-uuid (priority=10) for message msg123 from @User in channel 1396158748606726354 (filters: at_mention)
```

### Debugging Benefits

- Easy to grep for issues: `grep "NO TASK CREATED" logs/`
- Clear reasons for every routing decision
- Full context including channel IDs, user IDs, and filter results
- Appropriate log levels (INFO for normal, WARNING for unexpected)

## Testing

### Comprehensive Test Coverage
- 16 new tests covering all routing scenarios
- Tests verify both functionality and logging behavior
- Mock fixtures properly handle all dependencies
- Coverage includes:
  - WA users in monitored channels
  - Non-WA users in monitored channels
  - Deferral channel routing
  - Unmonitored channel rejection
  - Filter rejection scenarios
  - Channel ID extraction formats
  - Logging verification

## Deployment Notes

This patch contains critical fixes that restore proper Discord message handling.

### Deployment Steps
1. Deploy patch4 to production
2. Monitor logs for proper task creation
3. Verify @mentions are working in monitored channels

### Verification
Check logs for successful task creation:
```bash
# Should see task creation for monitored channels
grep "IS MONITORED - CREATING" logs/latest.log

# Check for any rejected messages
grep "NO TASK CREATED" logs/latest.log

# Verify filter operations
grep "FILTERED OUT by adaptive filter" logs/latest.log
```

Success indicators:
- Tasks created for all messages in monitored channels
- Clear logging showing routing decisions
- No "NO TASK CREATED" for monitored channel messages

## CI/CD Fixes

### Test Suite Fixes
Fixed 4 test failures in CI pipeline:

1. **test_discord_config_loading.py** - Updated to check warning logs for correct message format
2. **test_base_observer_numeric_ids.py** - Added missing `triggered_filters` attribute to mock
3. **test_discord_observer_routing.py** - Fixed persistence and uuid import patches

All tests now passing with 100% success rate.

## Commits
- `c4eaf178` - fix: Fix Discord observer to create tasks for WA users in monitored channels
- `b217bbd2` - feat: Add comprehensive logging for observer message routing decisions  
- `d23a71fa` - fix: Fix CI test failures

## Related Issues
- WA users' @mentions not creating tasks in #ai-social
- Missing observability for debugging message routing
- Channel ID extraction limited to single format

---

*This patch restores critical Discord functionality and adds comprehensive observability for production debugging.*