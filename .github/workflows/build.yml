name: Build and Deploy
# GitHub Container Registry permissions fixed in org settings

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  packages: write
  pull-requests: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Essential for accurate SonarQube results

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clean Python Cache and Test Artifacts
        run: |
          find . -type d -name __pycache__ -exec rm -rf {} + || true
          find . -type f -name "*.pyc" -delete || true
          find . -type f -name "*.pyo" -delete || true
          rm -rf .pytest_cache || true
          rm -f test_*.db || true
          rm -f ciris_engine.db || true
          rm -rf data/*.db || true

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install typing_extensions>=4.0.0
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run mypy strict type checking
        run: |
          mypy ciris_engine --config-file mypy.ini

      - name: Run tests and coverage
        env:
          CI: true
        run: |
          pytest tests/ -n 4 --cov=./ --cov-report=xml:coverage.xml

      - name: Display and write version
        env:
          CIRIS_BUILD_SIGN_KEY: ${{ secrets.CIRIS_BUILD_SIGN_KEY }}
        run: |
          python version.py
          cat BUILD_INFO.txt || echo "No BUILD_INFO.txt created"

      - name: Upload BUILD_INFO artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: BUILD_INFO.txt

      # SonarQube scan (only on main repo)
      - name: Check SonarQube conditions
        id: check_sonar
        run: |
          echo "Repository: ${{ github.repository }}"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          if [[ "$REPO_LOWER" == "cirisai/cirisagent" ]] && [[ -n "${{ secrets.SONAR_TOKEN }}" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: SonarQube Scan
        if: steps.check_sonar.outputs.should_run == 'true'
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-gui:
    name: Build GUI Assets
    needs: test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout CIRISGUI
        uses: actions/checkout@v4
        with:
          repository: CIRISAI/CIRISGUI
          path: cirisgui

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cirisgui/package-lock.json

      - name: Configure for static export
        run: |
          cd cirisgui
          # Ensure next.config.mjs has output: 'export'
          if ! grep -q "output.*:.*['\"]export['\"]" next.config.mjs 2>/dev/null; then
            echo "⚠️  Warning: next.config.mjs may need output: 'export' configuration"
            echo "Attempting to add it..."
            # Backup original
            cp next.config.mjs next.config.mjs.bak
            # Add output export if not present (simple approach)
            sed -i "s/const nextConfig = {/const nextConfig = {\n  output: 'export',/" next.config.mjs || true
          fi
          echo "✅ Static export configuration verified"

      - name: Install dependencies
        run: |
          cd cirisgui
          npm ci

      - name: Build static assets
        run: |
          cd cirisgui
          npm run build
          echo "✅ GUI build complete"
          ls -la out/

      - name: Upload GUI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gui-static-assets
          path: cirisgui/out/
          retention-days: 7

  build-wheel:
    name: Build Python Wheel
    needs: [test, build-gui]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download GUI artifacts
        uses: actions/download-artifact@v4
        with:
          name: gui-static-assets
          path: ciris_engine/gui_static/

      - name: Verify GUI assets
        run: |
          echo "GUI assets downloaded to ciris_engine/gui_static/"
          ls -la ciris_engine/gui_static/ | head -20
          FILE_COUNT=$(find ciris_engine/gui_static -type f | wc -l)
          echo "Total files: $FILE_COUNT"
          if [ "$FILE_COUNT" -lt 5 ]; then
            echo "⚠️  Warning: Very few GUI files found"
          else
            echo "✅ GUI assets look good"
          fi

      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine

      - name: Build wheel
        run: |
          python -m build --wheel
          ls -lh dist/

      - name: Check wheel contents
        run: |
          WHEEL_FILE=$(ls dist/*.whl)
          echo "Checking contents of $WHEEL_FILE"
          unzip -l "$WHEEL_FILE" | grep -E "(gui_static|covenant|main\.py)" | head -20 || echo "Pattern not found"
          echo ""
          echo "Total files in wheel:"
          unzip -l "$WHEEL_FILE" | tail -1

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: dist/*.whl
          retention-days: 30

  build:
    name: Build Docker Images
    needs: test
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Download BUILD_INFO artifact
        uses: actions/download-artifact@v4
        with:
          name: build-info
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: github.repository == 'CIRISAI/CIRISAgent' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from constants
        id: version
        run: |
          VERSION=$(grep "^CIRIS_VERSION = " ciris_engine/constants.py | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/cirisai/ciris-agent
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=${{ steps.version.outputs.version }},enable={{is_default_branch}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/agent/Dockerfile
          push: ${{ github.repository == 'CIRISAI/CIRISAgent' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository) }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64



      - name: Build Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.repository }}" != "CIRISAI/CIRISAgent" ]]; then
            echo "✅ Built images locally (fork - no push)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
              echo "✅ Built images locally (fork PR - no push)" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ Built and pushed images (same-repo PR)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "✅ Built and pushed images (branch push)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Images:" >> $GITHUB_STEP_SUMMARY
          echo "- ciris-agent" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Notify CIRISManager of Update
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.repository == 'CIRISAI/CIRISAgent'
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Just need the latest commit message

      - name: Extract Release Information
        id: release_info
        run: |
          # Extract semantic version from constants.py
          SEMANTIC_VERSION=$(grep "^CIRIS_VERSION = " ciris_engine/constants.py | cut -d'"' -f2)
          echo "Semantic version: $SEMANTIC_VERSION"

          # Extract changelog from CHANGELOG.md using Keep a Changelog format
          if [ -f "CHANGELOG.md" ]; then
            echo "Extracting changelog from CHANGELOG.md"
            CHANGELOG=$(python tools/extract_changelog.py CHANGELOG.md "$SEMANTIC_VERSION")
            echo "Extracted changelog: $CHANGELOG"
          else
            echo "No CHANGELOG.md found, using commit message fallback"
            CHANGELOG=$(git log -1 --pretty=format:"%s")
          fi

          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT
          echo "version=$SEMANTIC_VERSION" >> $GITHUB_OUTPUT

      - name: Notify CIRISManager
        run: |

          # Notify CIRISManager about new images with rich context from CHANGELOG.md
          # CIRISManager will orchestrate the deployment
          echo "Notifying CIRISManager with:"
          echo "  Version: ${{ steps.release_info.outputs.version }}"
          echo "  Changelog: ${{ steps.release_info.outputs.changelog }}"
          echo "  Risk Level: ${{ steps.release_info.outputs.risk_level }}"

          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST https://agents.ciris.ai/manager/v1/updates/notify \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"agent_image\": \"ghcr.io/cirisai/ciris-agent:latest\",
              \"strategy\": \"canary\",
              \"source\": \"github-actions\",
              \"commit_sha\": \"${{ github.sha }}\",
              \"changelog\": \"${{ steps.release_info.outputs.changelog }}\",
              \"version\": \"${{ steps.release_info.outputs.version }}\"
            }")

          # Extract HTTP status
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS:/d')

          echo "Response body: $body"
          echo "HTTP status: $http_status"

          # Check if successful (2xx status code)
          if [[ "$http_status" =~ ^2[0-9][0-9]$ ]]; then
            echo "✅ Successfully notified CIRISManager"
            echo "Deployment ID: $(echo "$body" | jq -r '.deployment_id // "unknown"')"
            echo "Strategy: $(echo "$body" | jq -r '.strategy // "unknown"')"
          else
            echo "❌ Failed to notify CIRISManager"
            echo "HTTP Status: $http_status"
            echo "Response: $body"
            exit 1
          fi

      - name: Monitor Deployment Status
        run: |
          # Give CIRISManager time to process
          sleep 10

          # Check deployment status
          echo "Checking deployment status..."
          status_response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" https://agents.ciris.ai/manager/v1/updates/status \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}")

          status_http=$(echo "$status_response" | grep "HTTP_STATUS:" | cut -d: -f2)
          status_body=$(echo "$status_response" | sed '/HTTP_STATUS:/d')

          if [[ "$status_http" =~ ^2[0-9][0-9]$ ]]; then
            echo "Deployment Status:"
            echo "$status_body" | jq '.'
          else
            echo "Could not retrieve deployment status"
          fi

          echo ""
          echo "CIRISManager will handle the deployment orchestration."
          echo "Agents will be notified based on the canary deployment strategy."
