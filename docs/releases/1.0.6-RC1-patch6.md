# Release v1.0.6-RC1-patch6

**Release Date:** August 28, 2025  
**Type:** Critical Security Fix & DMA Validation  
**Branch:** 1.0-RC1-patch6

## Critical Security Fix

### Discord WA Validation
Fixed critical security vulnerability where Discord usernames could be spoofed to impersonate Wise Authority users.

#### Security Changes
1. **Removed Username Matching**
   - Eliminated `msg.author_name == wa_discord_user` checks
   - Now only validates numeric Discord user IDs
   - Prevents username spoofing attacks

2. **Updated Validation Logic**
   - Changed from: `msg.author_id in self.wa_user_ids or msg.author_name == wa_discord_user`
   - Changed to: `msg.author_id in self.wa_user_ids` (ID only)
   - Applied to both passive and priority observation handlers

3. **Test Updates**
   - Renamed `test_default_wa_user_name_check` to `test_wa_user_id_only_check`
   - Now verifies that username matches are properly ignored
   - Confirms only numeric IDs are validated

## DMA Validation Fixes

### Schema Type Correction
Fixed `alignment_check` field in `EthicalDMAResult` from `Dict[str, Any]` to `str`.

#### Changes
1. **Schema Update**
   - Changed `alignment_check` from Dict to str type
   - Field now expects free-text ethical analysis as per prompt design
   - Fixes "Invalid JSON: key must be a string" errors

2. **Mock LLM Updates**
   - Updated both mock_llm implementations to return text strings
   - Provides properly formatted ethical analysis text
   - Maintains test compatibility

3. **Test Updates**
   - Updated all tests to use string alignment checks
   - Fixed context builder to handle text analysis
   - Improved type safety throughout

### Instructor Mode Configuration
Added environment variable support to switch instructor modes for fixing DMA validation failures.

#### Implementation
1. **Environment Variable Support**
   - Added `INSTRUCTOR_MODE` environment variable
   - Defaults to "JSON" mode for backward compatibility
   - Can be overridden to "TOOLS" mode for production agents

2. **Configuration Changes**
   ```python
   instructor_mode=os.environ.get("INSTRUCTOR_MODE", "JSON")
   ```
   - Applied to both primary and secondary LLM services
   - Allows per-agent configuration without code changes

3. **Use Cases**
   - Production datum agent can use `INSTRUCTOR_MODE=TOOLS`
   - Development/testing continues with default JSON mode
   - Fixes "Invalid JSON: key must be a string" errors

## Production Impact

### Issue Resolution
This patch addresses critical production issues discovered during datum agent monitoring:
1. DMA validation failures causing cascade failures
2. Discord messages incorrectly rejected/accepted based on usernames
3. Deferred WAKEUP thoughts stuck in pondering loops

### Deployment Notes
- Set `INSTRUCTOR_MODE=TOOLS` for datum agent
- Verify WA user IDs are numeric in configuration
- Monitor for reduced DMA validation errors

## Files Changed

1. **Security Fixes**
   - `/ciris_engine/logic/adapters/discord/discord_observer.py` - Removed username validation
   - `/tests/ciris_engine/logic/adapters/discord/test_discord_observer_routing.py` - Updated security tests

2. **Configuration**
   - `/ciris_engine/logic/runtime/service_initializer.py` - Added INSTRUCTOR_MODE support

## Testing

### Security Validation
```bash
# Verify only numeric IDs are checked
pytest tests/ciris_engine/logic/adapters/discord/test_discord_observer_routing.py::TestDiscordObserverRouting::test_wa_user_id_only_check -v
```

### DMA Validation
```bash
# Test with TOOLS mode
INSTRUCTOR_MODE=TOOLS python main.py --adapter discord --mock-llm
```

## Commits
- Reverted unauthorized main branch changes
- Applied security fixes to patch-6 branch
- Added environment variable configuration support
- Updated tests for security compliance

---

*This patch contains critical security fixes and should be deployed immediately to production.*