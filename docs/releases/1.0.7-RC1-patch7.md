# CIRIS 1.0.7-RC1-patch7 Release Notes

**Release Date:** August 28, 2025  
**Branch:** `1.0-RC1-patch7`

## Overview

This patch release focuses on enabling agent self-configuration through the MEMORIZE handler and fixing critical bugs in the secrets and filter systems. The agent can now properly update its configuration through CONFIG nodes, bridging the gap between memory operations and the configuration service.

## Key Features

### üîß Agent Self-Configuration via MEMORIZE

The agent can now update its own configuration by creating CONFIG nodes through the MEMORIZE action:

```python
# Adaptive Filter Configuration
$memorize adaptive_filter/spam_threshold CONFIG LOCAL value=0.8
$memorize adaptive_filter/trust_decay_rate CONFIG LOCAL value=0.05
$memorize adaptive_filter/caps_detection_enabled CONFIG LOCAL value=true
$memorize adaptive_filter/dm_priority CONFIG LOCAL value=CRITICAL
$memorize adaptive_filter/quality_threshold CONFIG LOCAL value=0.3

# Secrets Filter Configuration  
$memorize secrets_filter/api_key_detection CONFIG LOCAL value=strict
$memorize secrets_filter/jwt_detection_enabled CONFIG LOCAL value=true
$memorize secrets_filter/custom_patterns CONFIG LOCAL value=['PROJ-[0-9]{4}','SECRET-[A-Z]+']
$memorize secrets_filter/entropy_threshold CONFIG LOCAL value=4.0
$memorize secrets_filter/redaction_mode CONFIG LOCAL value=full

# Recall Configuration
$recall adaptive_filter/spam_threshold CONFIG LOCAL
$recall secrets_filter/api_key_detection CONFIG LOCAL
```

**What Changed:**
- MEMORIZE handler now detects `CONFIG LOCAL` nodes
- Automatically creates proper `ConfigNode` structures
- Transforms node IDs to config keys (e.g., `filter/caps_threshold` ‚Üí `filter.caps_threshold`)
- Validates and types configuration values

**Error Handling:**
- Detailed error messages when value is missing
- Examples provided for each data type
- Clear instructions for proper formatting

### üß™ QA Runner Filter Test Module

New comprehensive test module for adaptive and secrets filters:

- 20 test cases covering filter configuration and behavior
- Tests use mock LLM command format
- Covers both adaptive filters (spam, caps, trust) and secrets filters
- Integrated into QA runner framework

**Usage:**
```bash
python -m tools.qa_runner filters
```

## Bug Fixes

### üêõ SecretReference Attribute Fix
- **Issue:** Code was accessing `ref.secret_uuid` but SecretReference only has `uuid`
- **Fix:** Changed to use `ref.uuid` in `base_observer.py`
- **Impact:** Fixes error processing secrets in API messages

### üêõ SystemSnapshot Type Mismatch
- **Issue:** `detected_secrets` field expected `List[str]` but received `List[SecretReference]`
- **Fix:** Convert SecretReference objects to string UUIDs in `secrets_snapshot.py`
- **Impact:** Fixes SystemSnapshot validation errors preventing thought processing

### üêõ Filter Test Command Format
- **Issue:** Filter tests used natural language MEMORIZE commands that mock LLM didn't understand
- **Fix:** Updated all tests to use proper mock LLM syntax (`$memorize <node_id> [type] [scope]`)
- **Impact:** Filter tests now execute correctly

## Technical Details

### ConfigNode Structure

When a CONFIG node is created via MEMORIZE, the handler:

1. **Extracts the key** from node ID:
   - `filter/caps_threshold` ‚Üí `filter.caps_threshold`
   - `agent/name` ‚Üí `agent.name`

2. **Validates the value** and creates typed ConfigValue:
   - `bool_value` for booleans
   - `int_value` for integers
   - `float_value` for floats
   - `string_value` for strings
   - `list_value` for lists
   - `dict_value` for dictionaries

3. **Auto-populates metadata**:
   - `version`: Starts at 1
   - `updated_by`: Defaults to "agent"
   - `updated_at`: Current timestamp

### Error Messages

The system now provides detailed, actionable error messages:

```
MEMORIZE CONFIG FAILED: Missing required 'value' field for configuration 'filter.spam_threshold'

CONFIG nodes require both a key and a value. The key was extracted from the node ID, 
but no value was provided in the attributes.

To set a configuration value, include it in the node attributes. Examples:

For numeric values:
  $memorize filter/spam_threshold CONFIG LOCAL value=0.8
  $memorize filter/trust_decay CONFIG LOCAL value=0.05

For boolean values:
  $memorize filter/enabled CONFIG LOCAL value=true
  $memorize filter/debug_mode CONFIG LOCAL value=false
```

## Files Modified

### Core Changes
- `ciris_engine/logic/handlers/memory/memorize_handler.py` - Added CONFIG node handling
- `ciris_engine/logic/adapters/base_observer.py` - Fixed SecretReference attribute
- `ciris_engine/logic/context/secrets_snapshot.py` - Fixed detected_secrets type

### Test Infrastructure
- `tools/qa_runner/modules/filter_tests.py` - Comprehensive filter test module with 36 tests
- `tools/qa_runner/config.py` - Added FILTERS module
- `tools/qa_runner/modules/__init__.py` - Export FilterTestModule
- `tests/test_memorize_config_handler.py` - Unit tests for CONFIG node handling
- `tests/fixtures/mocks.py` - Mock objects for handler testing

### Version
- `ciris_engine/constants.py` - Version bump to 1.0.7

## Comprehensive Examples

### Adaptive Filter Configuration
```bash
# Set spam detection threshold
$memorize adaptive_filter/spam_threshold CONFIG LOCAL value=0.8
$recall adaptive_filter/spam_threshold CONFIG LOCAL

# Configure caps detection
$memorize adaptive_filter/caps_threshold CONFIG LOCAL value=0.7
$memorize adaptive_filter/caps_detection_enabled CONFIG LOCAL value=true

# Configure trust settings
$memorize adaptive_filter/trust_threshold CONFIG LOCAL value=0.5
$memorize adaptive_filter/trust_decay_rate CONFIG LOCAL value=0.05

# Configure DM detection
$memorize adaptive_filter/dm_detection_enabled CONFIG LOCAL value=true
$memorize adaptive_filter/dm_priority CONFIG LOCAL value=CRITICAL
```

### Secrets Filter Configuration
```bash
# Configure API key detection
$memorize secrets_filter/api_key_detection CONFIG LOCAL value=strict
$recall secrets_filter/api_key_detection CONFIG LOCAL

# Enable JWT detection
$memorize secrets_filter/jwt_detection_enabled CONFIG LOCAL value=true

# Add custom patterns
$memorize secrets_filter/custom_patterns CONFIG LOCAL value=['PROJ-[0-9]{4}','SECRET-[A-Z]+']

# Set entropy threshold
$memorize secrets_filter/entropy_threshold CONFIG LOCAL value=4.0

# Configure redaction mode
$memorize secrets_filter/redaction_mode CONFIG LOCAL value=full
```

### Updating Configurations
```bash
# Update existing value (increments version)
$memorize adaptive_filter/spam_threshold CONFIG LOCAL value=0.9
$recall adaptive_filter/spam_threshold CONFIG LOCAL  # Shows 0.9

# Toggle boolean value
$memorize adaptive_filter/dm_detection_enabled CONFIG LOCAL value=false
$recall adaptive_filter/dm_detection_enabled CONFIG LOCAL  # Shows false
```

## Testing

### Running Tests

```bash
# Run filter tests
python -m tools.qa_runner filters

# Run all QA tests including filters
python -m tools.qa_runner all

# Test CONFIG node creation manually
python main.py --adapter cli --mock-llm
# Then: $memorize filter/test CONFIG LOCAL value=123
```

### Test Coverage

**QA Test Results:**
```
Total Tests  ‚îÇ 36
Passed       ‚îÇ 36
Failed       ‚îÇ 0
Success Rate ‚îÇ 100.0%
Duration     ‚îÇ 94.12s
```

**Test Categories (36 tests total):**
- RECALL before MEMORIZE: 2 tests (verify not found)
- Adaptive filter configuration: 9 tests with recall verification
- Secrets filter configuration: 8 tests with recall verification
- CONFIG updates with version increment: 4 tests
- Secrets tool detection: 5 tests (API keys, JWT, custom patterns)
- Filter behavior: 4 tests
- Error handling: 2 tests
- User trust configuration: 2 tests

**Unit Tests (13 tests):**
- CONFIG node with numeric, boolean, list, dict values
- Missing value error handling with detailed examples
- Key transformation (/ to .)
- Non-CONFIG nodes pass through unchanged
- Secrets snapshot returns string UUIDs
- BaseObserver uses ref.uuid correctly

## Migration Guide

### For Developers

No breaking changes. The MEMORIZE handler is backward compatible - non-CONFIG nodes work as before.

### For Agent Operators

Agents can now self-configure using MEMORIZE commands. Monitor the audit log for configuration changes:

```python
# Check recent config changes
await audit_service.query_events(
    event_type="MEMORIZE",
    filters={"node_type": "CONFIG"}
)
```

## Known Limitations

1. **Mock LLM**: The mock LLM doesn't parse attribute syntax. Real LLMs will need to format MEMORIZE commands properly.

2. **Config Service Integration**: CONFIG nodes are stored but not automatically picked up by all services. Services must query the config service.

3. **Validation**: No schema validation on config values yet - services must validate their own configs.

## Security Considerations

- CONFIG nodes with `LOCAL` scope can be created without approval
- `IDENTITY` scope CONFIG nodes still require WA approval
- All config changes are audited
- Sensitive configs should use the secrets service instead

## Next Steps

Future improvements could include:
- Schema validation for config values
- Automatic service notification on config changes
- Config rollback capability
- Config templates and presets

## Contributors

- Configuration handling design and implementation
- Bug fixes for SecretReference and SystemSnapshot
- QA test infrastructure improvements

---

*For questions or issues, please open a GitHub issue or contact the development team.*