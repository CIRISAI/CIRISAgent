"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3835],{3120:(e,t,a)=>{a.d(t,{_:()=>l});var n=a(704);function o(){let e=window.location.hostname,t=window.location.pathname,a=t.startsWith("/agent/");if("agents.ciris.ai"!==e&&!a)return{mode:"standalone",agentId:"default",apiBase:"/v1"};{let e="default";e=a?t.split("/")[2]||"default":localStorage.getItem("selectedAgentId")||"default";let n="/api/".concat(e,"/v1");return{mode:"managed",agentId:e,apiBase:n}}}var r=a(5950);class i{configure(e,t){let a,{mode:n}=o();if("managed"===n)a="".concat(window.location.origin,"/api/").concat(e);else{let t=localStorage.getItem("agent_".concat(e,"_api_url"));a=t||window.location.origin}t||(t=r.a.getAccessToken()||void 0);let i={baseURL:a,authToken:t,agentId:e,mode:n};return this.hasConfigChanged(i)&&this.applyConfiguration(i),i}configureForOAuthCallback(e,t){let a,{mode:n}=o(),r={baseURL:"managed"===n?"".concat(window.location.origin,"/api/").concat(e):window.location.origin,authToken:t,agentId:e,mode:n};return this.applyConfiguration(r),this.storeConfiguration(r),r}getCurrentConfig(){return this.currentConfig}isConfiguredFor(e){return!!this.currentConfig&&this.currentConfig.agentId===e&&!!this.currentConfig.authToken}clear(){this.currentConfig=null,localStorage.removeItem("sdk_config"),this.log("SDK configuration cleared")}applyConfiguration(e){this.log("Applying SDK configuration:",e),n.AQ.setConfig({baseURL:e.baseURL,authToken:e.authToken}),this.currentConfig=e,this.log("SDK configured successfully")}hasConfigChanged(e){return!this.currentConfig||this.currentConfig.baseURL!==e.baseURL||this.currentConfig.authToken!==e.authToken||this.currentConfig.agentId!==e.agentId||this.currentConfig.mode!==e.mode}storeConfiguration(e){let t={baseURL:e.baseURL,agentId:e.agentId,mode:e.mode};localStorage.setItem("sdk_config",JSON.stringify(t)),"standalone"===e.mode&&e.baseURL!==window.location.origin&&localStorage.setItem("agent_".concat(e.agentId,"_api_url"),e.baseURL)}restoreConfiguration(){let e=localStorage.getItem("sdk_config");if(!e)return null;try{let t=JSON.parse(e),a=r.a.getAccessToken()||void 0;return{...t,authToken:a}}catch(e){return null}}log(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];this.debugMode&&console.log("[SDKConfigManager]",...t)}constructor(){this.currentConfig=null,this.debugMode=!1}}let l=new i},3835:(e,t,a)=>{a.d(t,{F:()=>h,f:()=>f});var n=a(4568),o=a(7620),r=a(9484),i=a(704),l=a(2942),s=a(3120),c=a(5950),u=a(4338);let g=(0,o.createContext)(null),d={agent_id:"datum",agent_name:"Datum (Local Dev)",status:"running",health:"healthy",api_url:u.env.NEXT_PUBLIC_CIRIS_API_URL||"http://localhost",api_port:8080,api_endpoint:u.env.NEXT_PUBLIC_CIRIS_API_URL||"http://localhost:8080",container_name:"ciris-agent-datum",created_at:new Date().toISOString(),started_at:new Date().toISOString(),update_available:!1};function h(e){let{children:t}=e,[a,u]=(0,o.useState)([]),[h,f]=(0,o.useState)(null),[_,m]=(0,o.useState)(new Map),[A,p]=(0,o.useState)(!1),[C,S]=(0,o.useState)(!1),[I,w]=(0,o.useState)(null),[v,y]=(0,o.useState)(!1),{user:k}=(0,r.A)(),b=(0,l.usePathname)(),R=async()=>{p(!0),w(null);try{let e=await i.AQ.manager.listAgents();if(u(e),y(!0),!h&&e.length>0){let t=e.find(e=>"running"===e.status)||e[0];await L(t.agent_id)}}catch(e){console.log("CIRIS Manager not available, using local dev agent"),u([d]),y(!1),h||await L(d.agent_id),e instanceof Error&&!e.message.includes("fetch")&&!e.message.includes("Failed to fetch")&&w(e)}finally{p(!1)}},N=async()=>{if(k&&h){S(!0);try{let e=await i.AQ.auth.getCurrentUser();if(e){let t={agentId:h.agent_id,apiRole:e.api_role,waRole:e.wa_role,isAuthority:"authority"===e.wa_role||"SYSTEM_ADMIN"===e.api_role,lastChecked:new Date};m(e=>{let a=new Map(e);return a.set(h.agent_id,t),a})}}catch(e){console.error("Failed to fetch role for agent ".concat(h.agent_id,":"),e)}S(!1)}},L=async e=>{let t=a.find(t=>t.agent_id===e);if(!t)return;console.log("[AgentContext] Selecting agent:",e),f(t);let n=c.a.getAccessToken()||void 0;s._.configure(e,n),localStorage.setItem("selectedAgentId",e),localStorage.setItem("selectedAgentName",t.agent_name),v||localStorage.setItem("agent_".concat(e,"_api_url"),"".concat(t.api_url,":").concat(t.api_port))},x=h&&_.get(h.agent_id)||null;return(0,o.useEffect)(()=>{let e=c.a.getAccessToken(),t=localStorage.getItem("selectedAgentId");e&&t&&(console.log("[AgentContext] Restoring SDK config for agent:",t),s._.configure(t,e)),R()},[]),(0,o.useEffect)(()=>{h&&k&&N()},[h,k]),(0,o.useEffect)(()=>{if(0===a.length||h)return;let e=b.match(/^\/agent\/([^\/]+)/);if(e&&e[1]){let t=e[1];if(a.find(e=>e.agent_id===t))return void L(t)}let t=localStorage.getItem("selectedAgentId");t&&L(t)},[a,b]),(0,n.jsx)(g.Provider,{value:{agents:a,currentAgent:h,currentAgentRole:x,agentRoles:_,selectAgent:L,refreshAgents:R,refreshAgentRoles:N,isLoadingAgents:A,isLoadingRoles:C,error:I,isManagerAvailable:v},children:t})}function f(){let e=(0,o.useContext)(g);if(!e)throw Error("useAgent must be used within an AgentProvider");return e}},9484:(e,t,a)=>{a.d(t,{A:()=>g,O:()=>u});var n=a(4568),o=a(7620),r=a(2942),i=a(3237),l=a(704),s=a(3120);let c=(0,o.createContext)(void 0);function u(e){let{children:t}=e,[a,u]=(0,o.useState)(null),[g,d]=(0,o.useState)(!0),[h,f]=(0,o.useState)(null),_=(0,r.useRouter)();(0,o.useEffect)(()=>{let e=window.location.pathname;"/login"===e||e.startsWith("/manager")?d(!1):m().then(e=>{e||A()});let t=localStorage.getItem("manager_token");t&&f(t);let a=e=>{console.log("[AuthContext] Native auth ready event received"),m()};return window.addEventListener("ciris_native_auth_ready",a),()=>{window.removeEventListener("ciris_native_auth_ready",a)}},[]);let m=async()=>{let e="true"===localStorage.getItem("isNativeApp"),t=localStorage.getItem("ciris_native_auth"),a=localStorage.getItem("ciris_auth_method"),n="true"===localStorage.getItem("ciris_show_setup");if(!e||!t)return!1;try{let e=JSON.parse(t);console.log("[AuthContext] Native auth detected - method:",a,"showSetup:",n),localStorage.setItem("selectedAgentId","datum"),s._.configure("datum");try{let e=await l.AQ.login("admin","ciris_admin_password"),t=l.AQ.auth.getAccessToken();return t&&s._.configure("datum",t),u(e),console.log("[AuthContext] Native auth login successful"),d(!1),n&&(console.log("[AuthContext] Redirecting to setup wizard"),localStorage.setItem("ciris_native_llm_mode","google"===a?"ciris_proxy":"custom"),_.push("/setup")),!0}catch(o){console.error("[AuthContext] Native auth login failed:",o);let t={user_id:e.googleUserId||"native_user",username:e.displayName||"Native User",role:"ADMIN",api_role:"ADMIN",permissions:["read","write","admin"],created_at:new Date().toISOString()};return u(t),d(!1),n&&(console.log("[AuthContext] Redirecting to setup wizard (mock user)"),localStorage.setItem("ciris_native_llm_mode","google"===a?"ciris_proxy":"custom"),_.push("/setup")),!0}}catch(e){return console.error("[AuthContext] Failed to parse native auth data:",e),!1}},A=async()=>{try{if(l.AQ.isAuthenticated()){let e=await l.AQ.auth.getMe();u(e)}}catch(e){console.error("Auth check failed:",e)}finally{d(!1)}},p=(0,o.useCallback)(async(e,t)=>{try{let a=localStorage.getItem("selectedAgentId");if(!a)throw Error("No agent selected");s._.configure(a);let n=await l.AQ.login(e,t),o=l.AQ.auth.getAccessToken();o&&s._.configure(a,o),u(n),i.Ay.success("Welcome, ".concat(n.username||n.user_id,"!")),_.push("/")}catch(e){throw i.Ay.error(e.message||"Login failed"),e}},[_]),C=(0,o.useCallback)(async()=>{try{await l.AQ.logout(),u(null),i.Ay.success("Logged out successfully"),_.push("/login")}catch(e){console.error("Logout failed:",e),i.Ay.error("Logout failed")}},[_]),S=(0,o.useCallback)(e=>!!a&&(a.permissions.includes(e)||"SYSTEM_ADMIN"===a.role),[a]),I=(0,o.useCallback)(e=>{if(!a)return!1;let t=["OBSERVER","ADMIN","AUTHORITY","SYSTEM_ADMIN"];return t.indexOf(a.role)>=t.indexOf(e)},[a]),w=(0,o.useCallback)(e=>{l.AQ.setConfig({authToken:e})},[]),v=(0,o.useCallback)(()=>!!h,[h]);return(0,n.jsx)(c.Provider,{value:{user:a,loading:g,login:p,logout:C,hasPermission:S,hasRole:I,setUser:u,setToken:w,managerToken:h,setManagerToken:f,isManagerAuthenticated:v},children:t})}function g(){let e=(0,o.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);
