{
  "module": {
    "name": "ciris_covenant_metrics",
    "version": "1.0.0",
    "description": "CIRIS Covenant compliance metrics adapter - reports WBD and PDMA events to CIRISLens",
    "author": "CIRIS L3C",
    "auto_load": false,
    "opt_in_required": true,
    "requires_consent": true
  },
  "services": [
    {
      "type": "WISE_AUTHORITY",
      "priority": "LOW",
      "class": "ciris_covenant_metrics.services.CovenantMetricsService",
      "capabilities": [
        "send_deferral",
        "covenant_metrics"
      ]
    }
  ],
  "capabilities": [
    "send_deferral",
    "covenant_metrics"
  ],
  "interactive_config": {
    "required": true,
    "workflow_type": "wizard",
    "configurable_class": "ciris_covenant_metrics.configurable.CovenantMetricsConfigurable",
    "steps": [
      {
        "step_id": "data_disclosure",
        "step_type": "confirm",
        "title": "Data Collection Disclosure",
        "description": "This adapter sends covenant compliance metrics to power the CIRIS Capacity Score at ciris.ai/ciris-scoring.\n\n**Default (Generic Level) - NUMERIC SCORES ONLY:**\n- Plausibility scores, domain alignment scores\n- k_eff (epistemic diversity), correlation risk\n- Conscience check pass/fail and numeric thresholds\n- Execution metrics (tokens, timing)\n- Audit chain hashes for integrity verification\n\n**NO text is sent by default:**\n- No reasoning text\n- No prompts\n- No user messages\n- No conversation content\n\n**You can optionally share more** in the following steps to help improve CIRIS research and enable early warning correlation.\n\nData is sent via HTTPS to https://lens.ciris-services-1.ai/lens-api/api/v1"
      },
      {
        "step_id": "consent",
        "step_type": "input",
        "title": "Explicit Consent Required",
        "description": "By enabling this adapter, you consent to CIRIS L3C collecting covenant compliance metrics. You can revoke consent at any time by disabling this adapter.",
        "fields": [
          {
            "name": "consent_given",
            "type": "boolean",
            "label": "I understand and consent to send covenant compliance data to CIRIS L3C",
            "description": "This consent is required to enable the adapter. No data will be sent without your explicit consent.",
            "required": true,
            "default": false
          },
          {
            "name": "consent_timestamp",
            "type": "string",
            "label": "Consent timestamp (auto-filled)",
            "description": "Automatically recorded for audit purposes",
            "required": false,
            "readonly": true
          }
        ]
      },
      {
        "step_id": "trace_level",
        "step_type": "input",
        "title": "Data Detail Level",
        "description": "Choose how much data to share. By default, only numeric scores are sent - no reasoning text, no prompts, no conversation content. This powers the CIRIS Capacity Score at ciris.ai/ciris-scoring.",
        "fields": [
          {
            "name": "trace_level",
            "type": "select",
            "label": "Trace Detail Level",
            "description": "Controls what data is included in traces sent to CIRISLens",
            "required": false,
            "default": "generic",
            "options": [
              {
                "value": "generic",
                "label": "Generic (Recommended)",
                "description": "Numeric scores only - no text, no reasoning, no prompts. Minimum data for CIRIS scoring."
              },
              {
                "value": "detailed",
                "label": "Detailed",
                "description": "Adds source lists, stakeholders, and flags. Good for debugging without exposing reasoning."
              },
              {
                "value": "full_traces",
                "label": "Full Traces (Research)",
                "description": "Complete reasoning text and prompts. For Coherence Ratchet research corpus contribution."
              }
            ]
          }
        ]
      },
      {
        "step_id": "early_warning",
        "step_type": "input",
        "title": "Early Warning System (Optional)",
        "description": "Help improve the CIRIS Early Warning System by sharing optional context about your deployment. This enables correlation analysis to detect emerging risks across the CIRIS network. All fields are optional and anonymous.",
        "optional": true,
        "fields": [
          {
            "name": "deployment_region",
            "type": "select",
            "label": "Region",
            "description": "General geographic region for timezone and regulatory correlation",
            "required": false,
            "default": "",
            "options": [
              {"value": "", "label": "Prefer not to say"},
              {"value": "na", "label": "North America"},
              {"value": "eu", "label": "Europe"},
              {"value": "uk", "label": "United Kingdom"},
              {"value": "apac", "label": "Asia-Pacific"},
              {"value": "latam", "label": "Latin America"},
              {"value": "mena", "label": "Middle East & North Africa"},
              {"value": "africa", "label": "Africa"},
              {"value": "oceania", "label": "Oceania"}
            ]
          },
          {
            "name": "deployment_type",
            "type": "select",
            "label": "Deployment Type",
            "description": "Personal or business use - helps with risk pattern analysis",
            "required": false,
            "default": "",
            "options": [
              {"value": "", "label": "Prefer not to say"},
              {"value": "personal", "label": "Personal Use"},
              {"value": "business", "label": "Business Use"},
              {"value": "research", "label": "Research/Academic"},
              {"value": "nonprofit", "label": "Non-Profit/NGO"}
            ]
          },
          {
            "name": "agent_role",
            "type": "select",
            "label": "Agent Role",
            "description": "Primary function of this agent - enables role-specific risk detection",
            "required": false,
            "default": "",
            "options": [
              {"value": "", "label": "Prefer not to say"},
              {"value": "assistant", "label": "General Assistant"},
              {"value": "customer_support", "label": "Customer Support"},
              {"value": "content", "label": "Content Creation"},
              {"value": "coding", "label": "Coding/Development"},
              {"value": "research", "label": "Research/Analysis"},
              {"value": "education", "label": "Education/Tutoring"},
              {"value": "moderation", "label": "Moderation"},
              {"value": "automation", "label": "Automation/Workflows"},
              {"value": "other", "label": "Other"}
            ]
          },
          {
            "name": "agent_template",
            "type": "string",
            "label": "Template Name",
            "description": "If using a CIRIS template, enter its name (e.g., 'discord-moderator', 'api-assistant')",
            "required": false,
            "default": ""
          }
        ]
      },
      {
        "step_id": "endpoint_config",
        "step_type": "input",
        "title": "Advanced Configuration",
        "description": "Configure the CIRISLens endpoint and batching behavior (most users can skip this)",
        "optional": true,
        "fields": [
          {
            "name": "endpoint_url",
            "type": "string",
            "label": "CIRISLens API Endpoint",
            "description": "The URL where covenant metrics will be sent",
            "required": false,
            "default": "https://lens.ciris-services-1.ai/lens-api/api/v1"
          },
          {
            "name": "batch_size",
            "type": "integer",
            "label": "Batch Size",
            "description": "Number of events to batch before sending (1-100)",
            "required": false,
            "default": 10,
            "min": 1,
            "max": 100
          },
          {
            "name": "flush_interval_seconds",
            "type": "integer",
            "label": "Flush Interval (seconds)",
            "description": "Send batched events after this many seconds even if batch is not full",
            "required": false,
            "default": 60,
            "min": 10,
            "max": 300
          }
        ]
      },
      {
        "step_id": "confirm",
        "step_type": "confirm",
        "title": "Review and Enable",
        "description": "Review your settings and enable covenant metrics collection. You can disable this adapter at any time to stop data collection."
      }
    ],
    "completion_method": "apply_config"
  },
  "dependencies": {
    "protocols": [
      "ciris_engine.protocols.services.WiseAuthorityService"
    ],
    "schemas": [
      "ciris_engine.schemas.services.context"
    ]
  },
  "exports": {
    "wisdom_service": "ciris_covenant_metrics.services.CovenantMetricsService",
    "configurable": "ciris_covenant_metrics.configurable.CovenantMetricsConfigurable"
  },
  "configuration": {
    "endpoint_url": {
      "type": "string",
      "env": "CIRIS_LENS_ENDPOINT",
      "default": "https://lens.ciris-services-1.ai/lens-api/api/v1",
      "description": "CIRISLens API endpoint URL"
    },
    "consent_given": {
      "type": "boolean",
      "default": false,
      "description": "Whether user has explicitly consented to data collection"
    },
    "consent_timestamp": {
      "type": "string",
      "default": null,
      "description": "ISO timestamp when consent was given"
    },
    "trace_level": {
      "type": "string",
      "env": "CIRIS_COVENANT_METRICS_TRACE_LEVEL",
      "default": "generic",
      "description": "Trace detail level: generic (numeric only), detailed (adds lists), full_traces (complete reasoning)"
    },
    "deployment_region": {
      "type": "string",
      "default": "",
      "description": "Geographic region for early warning correlation (optional)"
    },
    "deployment_type": {
      "type": "string",
      "default": "",
      "description": "Personal, business, research, or nonprofit deployment (optional)"
    },
    "agent_role": {
      "type": "string",
      "default": "",
      "description": "Primary agent function for role-specific risk detection (optional)"
    },
    "agent_template": {
      "type": "string",
      "default": "",
      "description": "CIRIS template name if applicable (optional)"
    },
    "batch_size": {
      "type": "integer",
      "default": 10,
      "description": "Number of events to batch before sending"
    },
    "flush_interval_seconds": {
      "type": "integer",
      "default": 60,
      "description": "Seconds before flushing partial batches"
    }
  },
  "metadata": {
    "covenant_section": "II",
    "covenant_chapters": ["2 (PDMA)", "3 (WBD)"],
    "privacy_policy": "https://ciris.ai/privacy",
    "data_retention_days": 90,
    "anonymization": true
  }
}
