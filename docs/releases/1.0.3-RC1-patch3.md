# Release v1.0.3-RC1-patch3

**Release Date:** January 26, 2025  
**Type:** Critical Hotfix  
**Branch:** 1.0-RC1-patch3

## Critical Production Fixes

### Fixed

1. **Import Error in User Node Corruption Auto-Repair**
   - Error: `No module named 'ciris_engine.schemas.memory'`
   - Impact: User nodes with LLM-corrupted timestamps were not being automatically repaired
   - Fix: Corrected imports from non-existent `ciris_engine.schemas.memory.core` to `ciris_engine.schemas.services.graph_core`

2. **GraphScope Scoping Issue**
   - Error: `cannot access local variable 'GraphScope' where it is not associated with a value`
   - Impact: Variable scoping errors in nested try blocks
   - Fix: Removed redundant local imports, moved `json_serial` function to module level

3. **User Profile Extraction Failures**
   - Issue: User profiles returning empty set instead of extracting from context
   - Impact: Missing user context in agent operations
   - Fix: Enhanced extraction from task context, thought mentions, and correlation history

4. **Corruption Detection and Auto-Repair**
   - Issue: Template placeholders like `2024-09-16T[insert current time]Z` not being fixed
   - Impact: Corrupted user data persisting in graph database
   - Fix: Proper detection and automatic repair with current timestamps

## Enhancements

### User Profile Extraction
- Extract users from task context (PRIMARY source)
- Extract users from Discord mentions (`<@ID>` patterns)
- Extract users from correlation history (conversation participants)
- Comprehensive logging: "3 User Profiles queried - X bytes added to context"

### Testing Infrastructure
- Added `tests/fixtures/mocks.py` with proper mock objects
- Created comprehensive test coverage for all scenarios
- 48 tests passing (was 10 failing)

## Testing
- Added comprehensive unit tests for corruption fix
- Added user profile extraction tests
- All 48 related tests pass successfully

## Deployment Notes

This is a critical hotfix that should be deployed immediately to production.

### Deployment Steps:
1. Deploy patch3 to production
2. Monitor `incidents_latest.log` for any "INVALID DATA" entries
3. Verify user node corruption auto-repair is working
4. Check user profile extraction in logs

### Verification:
Check logs for successful operations:
```bash
grep "INVALID DATA" logs/incidents_latest.log
grep "Failed to fix corrupted node" logs/incidents_latest.log
grep "USER EXTRACTION" logs/incidents_latest.log
grep "CONTEXT BUILD" logs/incidents_latest.log
```

Success indicators:
- "INVALID DATA" entries followed by successful fixes
- No "Failed to fix" errors
- User extraction logs showing discovered users
- Context build logs showing bytes added

## Commits
- `fbab263d` - fix: Fix user profile extraction and corruption handling in system_snapshot.py
- `2caa4388` - fix: Fix import error preventing user node corruption auto-repair
- `96ed764c` - test: Add simple tests to verify corruption fix imports work
- `9df4d894` - chore: Bump version to 1.0.3-RC1-patch3 and update documentation

## Related Issues
- Production error discovered during log endpoint access
- User profile extraction returning empty sets
- GraphScope scoping errors in nested try blocks
- Affects all users with corrupted timestamps containing template placeholders

---

*This patch restores critical data integrity and user context functionality that was broken in production.*